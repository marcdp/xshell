
<script type="module">
    import xshell, { Utils } from "xshell";
    import XController from "x-controller";
    
    xshell.pages.createController(new XController({
        state: {
            modules: [],
            selected: ""
        },
        async onCommand(command, args, page) {
            if (command == "load") {
                //load
                await this.onCommand("refresh");
                //listen
                page.bindEvent(xshell.bus, "xshell:navigation:end", (event) => {
                    let page = xshell.navigation.getPage();
                    let src = page.src;
                    if (page.srcPage) src = page.srcPage;
                    let moduleName = xshell.modules.resolveModuleName(src);
                    this.state.selected = moduleName ?? "";
                });

            } else if (command == "refresh") {
                //refresh
                let page = xshell.navigation.getPage();
                let src = page.src;
                if (page.srcPage) src = page.srcPage;
                let moduleName = xshell.modules.resolveModuleName(src);
                let modules = xshell.config.getAsObjects("modules");
                for(let target of modules) {
                    if (target.type == "application") {
                        let menu = xshell.config.get("modules." + target.name + ".menus.main", "");
                        if (menu) {
                            let aux = target.start;
                            let defaultMenuitems = Utils.findObjectsPath(menu, "href", target.start)
                            if (defaultMenuitems) {
                                let defaultMenuitem = defaultMenuitems[defaultMenuitems.length - 1];
                                this.state.modules.push({
                                    name: target.name,
                                    label: target.label,
                                    description: target.description || "",
                                    href: defaultMenuitem.href,
                                    logo: target.logo || "x-module"                                    
                                });
                            }
                        }
                    }
                };
                this.state.selected = moduleName ?? "";
            }
        }
    }));
</script>

<template>
    <p>
        Please select the aplication to use:
    </p>
    
    <x-listview view="icons">
        <x-listview-item 
            x-for="module in state.modules"
            x-class:selected="(state.selected == module.name)"
            x-attr:label="module.label"
            x-attr:description="module.description"
            x-attr:icon="module.logo"
            x-attr:href="module.href"
            target="#root"
        ></x-listview-item>
    </x-listview>       
    
</template>
