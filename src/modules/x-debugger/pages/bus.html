<script type="module">
    import xshell, { bus, config, utils, usePageController } from "xshell";
    import XController from "x-controller";
    
    usePageController(new XController({
        state: {
            registry: [],
            query_type: "",
            query_ts: "",
            query_detail: ""
        },
        async onCommand(command, params, page) {
            if (command == "load") {
                // listen to all bus events
                page.bindEvent(bus, "*", (event)=>{
                    this.state.registry.push({ 
                        type: event.type,
                        ts: event.ts,
                        detail: event.detail
                    });
                    this.onCommand("refresh", {}, page);
                });
                page.bindEvent(this.state, "change:query_type", "refresh");
                page.bindEvent(this.state, "change:query_ts", "refresh");
                page.bindEvent(this.state, "change:query_detail", "refresh");

            } else if (command == "clear") {
                // clear
                this.state.registry = [];

            } else if (command == "refresh") {
                //refresh
                for(let item of this.state.registry) {
                    let show = true;
                    if (this.state.query_type && item.type.indexOf(this.state.query_type) == -1 ) show = false;
                    if (this.state.query_detail && JSON.stringify(item.detail).indexOf(this.state.query_detail) == -1 ) show = false;
                    item.show = show;
                }
                this.invalidate();
            }
        }
    }));
</script>

<template>
    
    <x-listview ref="listview" view="details" >
        <div slot="column">
            <x-datafield type="search" x-model="state.query_type" placeholder="Type"></x-datafield>
        </div>
        <div slot="column">
            <x-datafield type="search" x-model="state.query_ts" placeholder="Time"></x-datafield>
        </div>
        <div slot="column">
            <x-datafield type="search" x-model="state.query_detail" placeholder="Detail"></x-datafield>
        </div>
        <div slot="column">
            <x-button class="plain" command="clear" icon="x-clear" title="Clear list contents"></x-button>
        </div>
        <x-listview-item x-for="item in state.registry" x-attr:label="item.type" icon="x-thunder" x-show="item.show">
            <x-datetime x-prop:value="item.ts" format="iso"></x-datetime>
            <x-json x-prop:value="JSON.stringify(item.detail)"></x-json>
            <div></div>
        </x-listview-item>

    </x-listview>       
    
</template>
