<script type="module">
    import xshell, { bus, config, utils, loader, usePageController } from "xshell";
    import XController from "x-controller";
    
    usePageController(new XController({
        state: {
            registry: [],
            query_resource: "",
            query_src: "",
            query_status: "",
        },
        async onCommand(command, args, page) {
            if (command == "load") {
                // setup registry of already loaded resources
                let register = (detail) => {
                    this.state.registry.push({
                        resource: detail.resource,
                        resourceShort: detail.resource.split("?")[0] + (detail.resource.indexOf("?") != -1 ? "?..." : ""),
                        src: detail.src,
                        srcShort: detail.src.split("?")[0] + (detail.src.indexOf("?") != -1 ? "?..." : ""),
                        status: detail.status,
                        show: true,
                    });
                }
                for(let loaderRegistryItem of loader.registry) {
                    register(loaderRegistryItem);
                }
                // listen to loader events
                page.bindEvent(bus, "loader:resource:fetch", (event)=>{
                    register(event.detail)
                    this.onCommand("refresh");
                });
                page.bindEvent(bus, "loader:resource:loaded", (event)=>{
                    for (let item of this.state.registry) {
                        if (item.resource == event.detail.resource) {
                            item.status = "loaded";
                            break;
                        }
                    }
                    this.onCommand("refresh");
                });
                page.bindEvent(bus, "loader:resource:error", (event)=>{
                    for (let item of this.state.registry) {
                        if (item.resource == event.detail.resource) {
                            item.status = "error";
                            break;
                        }
                    }
                    this.onCommand("refresh");
                });
                page.bindEvent(this.state, "change:query_resource", "refresh");
                page.bindEvent(this.state, "change:query_src", "refresh");
                page.bindEvent(this.state, "change:query_status", "refresh");

            } else if (command == "clear") {
                // clear
                this.state.registry = [];

            } else if (command == "refresh") {
                // refresh
                for(let item of this.state.registry) {
                    let show = true;
                    if (this.state.query_resource && item.resource.indexOf(this.state.query_resource) == -1 ) show = false;
                    if (this.state.query_src && item.src.indexOf(this.state.query_src) == -1 ) show = false;
                    if (this.state.query_status && item.status.indexOf(this.state.query_status) == -1 ) show = false;
                    item.show = show;
                }
                this.invalidate();
            }
        }
    }));
</script>

<template>
    
    <x-listview view="details" auto-scroll>
        <div slot="column">
            <x-datafield type="search" x-model="state.query_resource" placeholder="Resource"></x-datafield>
        </div>
        <div slot="column">
            <x-datafield type="search" x-model="state.query_src" placeholder="Source"></x-datafield>
        </div>
        <div slot="column" style="width:6em">
            <x-datafield type="search" x-model="state.query_load_time" placeholder="Load Time"></x-datafield>
        </div>
        <div slot="column" style="width:6em">
            <x-datafield type="search" x-model="state.query_load_size" placeholder="Size"></x-datafield>
        </div>
        <div slot="column" style="width:4em;">
            <x-datafield type="search" x-model="state.query_status" placeholder="Status" style="flex:1"></x-datafield>
        </div>
        <div slot="column">
            <x-button class="plain" command="clear" icon="x-clear" title="Clear list contents"></x-button>
        </div>
        <x-listview-item x-for="item in state.registry" x-attr:label="item.resourceShort" icon="x-file" x-show="item.show">
            <a x-attr:href="item.src" x-attr:title="item.src" target="_blank" x-text="item.srcShort"></a>
            <div><x-time-ms x-prop:value="item.loadTime"></x-time-ms></div>
            <div><x-file-size x-prop:value="item.loadSize"></x-file-size></div>
            <div>{{ item.status }}</div>
            <div></div>
        </x-listview-item>
    </x-listview>       
    
</template>
